<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Cantonese TTS â€¢ JoDFun</title>

  <style>
    :root{
      --bg: #f7f8fb;
      --bg2:#f3f5ff;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --primary:#6b8cff;
      --accent:#ffb703;
      --danger:#ef4444;
      --radius:16px;
      --shadow:0 10px 30px rgba(0,0,0,0.08);
      --border:#e5e7eb;

      --tap:44px; /* mobile-friendly */
    }

    /* Dark mode theme (set by [data-theme="dark"]) */
    html[data-theme="dark"]{
      --bg:#0b1220;
      --bg2:#0f1a33;
      --card:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --primary:#7aa2ff;
      --accent:#ffd166;
      --danger:#fb7185;
      --shadow:0 12px 40px rgba(0,0,0,0.40);
      --border:#24314e;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      min-height:100vh;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      color:var(--text);
      background:linear-gradient(180deg,var(--bg2),var(--bg));
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    /* iOS safe-area */
    .container{
      max-width: 980px;
      margin: 0 auto;
      padding: calc(18px + env(safe-area-inset-top)) 18px calc(18px + env(safe-area-inset-bottom));
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin: 10px 0 18px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:14px;
      min-width: 0;
    }

    .brand h1{
      margin:0;
      font-size: 22px;
      font-weight: 800;
      letter-spacing:0.2px;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .brand p{
      margin:6px 0 0;
      font-size:13px;
      color:var(--muted);
      line-height:1.3;
    }

    .logoWrap{
      width:64px;
      height:64px;
      border-radius:18px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), rgba(255,232,179,0.55));
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.03);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
      overflow:hidden;
    }

    /* Card */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding: 18px;
    }

    /* Layout */
    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }

    @media (min-width: 860px){
      .card{ padding: 22px; }
    }

    .sectionTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }

    .sectionTitle h2{
      margin:0;
      font-size:16px;
      font-weight:800;
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:10px;
      margin: 10px 0;
    }

    label{
      font-weight:700;
      font-size:13px;
      color:var(--muted);
    }

    select, button, input[type="range"]{
      font-size:15px;
    }

    select{
      height: var(--tap);
      padding: 0 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      min-width: min(520px, 100%);
      outline: none;
    }

    textarea{
      width:100%;
      min-height: 190px;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      font-size:16px;
      line-height:1.6;
      resize:none;
      outline:none;

      /* iOS: prevent zoom on focus */
      -webkit-text-size-adjust: 100%;
    }

    textarea:focus, select:focus{
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(107,140,255,0.20);
    }

    /* Buttons */
    .btn{
      height: var(--tap);
      padding: 0 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      font-weight:800;
      cursor:pointer;
      transition: transform .05s ease, box-shadow .05s ease, opacity .15s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ box-shadow: 0 8px 18px rgba(0,0,0,0.10); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: var(--primary);
      border: none;
      color: #fff;
    }
    .btn.soft{
      background: rgba(148,163,184,0.12);
      border: 1px solid rgba(148,163,184,0.18);
    }
    .btn.warn{
      background: rgba(239,68,68,0.14);
      border: 1px solid rgba(239,68,68,0.25);
      color: var(--text);
    }
    html[data-theme="dark"] .btn.warn{
      color: #ffe4e6;
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top: 12px;
    }

    /* Sliders */
    .sliderRow{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 12px;
    }

    .slider{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: rgba(148,163,184,0.07);
    }
    html[data-theme="dark"] .slider{
      background: rgba(148,163,184,0.06);
    }

    .sliderHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 8px;
    }
    .sliderHead strong{
      font-size:14px;
    }
    .chip{
      font-size:12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(255,255,255,0.35);
    }
    html[data-theme="dark"] .chip{
      background: rgba(15,23,42,0.35);
    }

    input[type="range"]{
      width:100%;
      accent-color: var(--primary);
    }

    .mini{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
    }

    /* Status */
    #status{
      margin-top: 10px;
      color: var(--muted);
      font-size: 14px;
      line-height:1.4;
      min-height: 20px;
      white-space: pre-line;
    }

    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 13px;
      line-height:1.4;
    }

    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .switch{
      width: 50px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(148,163,184,0.14);
      position: relative;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .switch::after{
      content:"";
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: var(--card);
      border: 1px solid var(--border);
      position:absolute;
      top: 50%;
      left: 3px;
      transform: translateY(-50%);
      transition: left .18s ease;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    }
    html[data-theme="dark"] .switch{
      background: rgba(122,162,255,0.18);
    }
    html[data-theme="dark"] .switch::after{
      left: 23px;
    }

    footer{
      text-align:center;
      margin: 26px 0 10px;
      font-size: 13px;
      color: var(--muted);
      opacity:0.92;
    }

    footer a{
      color: inherit;
      font-weight: 800;
      text-decoration: none;
      border-bottom: 1px dashed rgba(148,163,184,0.55);
    }
    footer a:hover{
      border-bottom-style: solid;
    }

    /* Reduce motion for accessibility */
    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="logoWrap" aria-label="JoDFun capybara mascot">
          <!-- ğŸ¦« Simple SVG capybara mascot -->
          <svg width="56" height="56" viewBox="0 0 128 128" role="img" aria-label="Capybara logo">
            <defs>
              <linearGradient id="fur" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="#caa472"/>
                <stop offset="1" stop-color="#b78958"/>
              </linearGradient>
              <linearGradient id="shine" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0" stop-color="#ffffff" stop-opacity="0.9"/>
                <stop offset="1" stop-color="#ffffff" stop-opacity="0.0"/>
              </linearGradient>
            </defs>

            <rect x="6" y="6" width="116" height="116" rx="26" fill="#fff6d1" opacity="0.9"/>
            <rect x="6" y="6" width="116" height="116" rx="26" fill="url(#shine)" opacity="0.35"/>

            <path d="M26 71c0-22 20-38 44-38s44 16 44 38-20 36-44 36S26 93 26 71z"
                  fill="url(#fur)" stroke="#6b4f33" stroke-opacity="0.35" stroke-width="3"/>
            <path d="M42 76c0-10 12-18 28-18s28 8 28 18-12 17-28 17S42 86 42 76z"
                  fill="#d8b086" opacity="0.95"/>
            <ellipse cx="70" cy="78" rx="7" ry="5" fill="#3b2a1d" opacity="0.85"/>
            <circle cx="52" cy="64" r="6" fill="#1f2937"/>
            <circle cx="88" cy="64" r="6" fill="#1f2937"/>
            <circle cx="50" cy="62" r="2" fill="#ffffff" opacity="0.9"/>
            <circle cx="86" cy="62" r="2" fill="#ffffff" opacity="0.9"/>
            <circle cx="44" cy="76" r="5" fill="#ffb703" opacity="0.45"/>
            <circle cx="96" cy="76" r="5" fill="#ffb703" opacity="0.45"/>
            <path d="M33 55c4-7 10-10 16-7-2 7-7 12-16 7z" fill="#b78958" opacity="0.95"/>
            <path d="M60 87c6 5 14 5 20 0" fill="none" stroke="#6b4f33" stroke-opacity="0.5" stroke-width="4" stroke-linecap="round"/>
          </svg>
        </div>

        <div style="min-width:0">
          <h1>Cantonese Read-Aloud</h1>
          <p>Browser-native Cantonese TTS â€¢ Web Speech API â€¢ Cute capybara-grade professionalism</p>
        </div>
      </div>

      <!-- ğŸŒˆ Dark mode toggle -->
      <div class="toggle" title="Toggle dark mode">
        <span style="color:var(--muted);font-weight:800;font-size:13px;">Dark</span>
        <div id="themeSwitch" class="switch" role="switch" aria-checked="false" tabindex="0"></div>
      </div>
    </div>

    <div class="grid">
      <!-- Main card -->
      <div class="card">
        <div class="sectionTitle">
          <h2>Speak</h2>
          <button id="reload" class="btn soft" type="button">â†» Reload voices</button>
        </div>

        <div class="row">
          <label for="voice">Voice</label>
          <select id="voice" aria-label="Voice selection"></select>
        </div>

        <textarea id="text" inputmode="text" autocomplete="off" autocapitalize="off" spellcheck="false">
å¾å‰ï¼Œæœ‰ä¸€éš»è¶…ç´š chill å˜… capybaraï¼Œå¤§å®¶éƒ½å«ä½¢ã€Œé˜¿å•¡ã€ã€‚
é˜¿å•¡æœ€é¾æ„åšå˜…äº‹å””ä¿‚æ¸¸æ°´ã€å””ä¿‚é£Ÿè‰â€”â€”
è€Œä¿‚æ‹ä½éƒ¨ iPadï¼Œtab tab tabï¼Œå†åŠ ä¸€éƒ¨ iPhoneï¼Œ100% å°ˆæ³¨æ»‘åˆ°å…¥ç¥ã€‚

æœ‰ä¸€æ—¥ï¼Œé˜¿å•¡ä¸€é‚Šæ…¢æ…¢è¡Œï¼Œä¸€é‚Šç”¨æ‰‹æŒ‡å–º iPad åº¦ç•«ç•«ï¼Œ
ã€Œtabã€tabã€swipeï½ã€
ä¸–ç•Œç™¼ç”Ÿä¹œäº‹ï¼Ÿ
å””é‡è¦ã€‚

ä½¢è¡Œå‘€è¡Œï¼Œå®Œå…¨å””çŸ¥è‡ªå·±å…¶å¯¦â€”â€”
è¸©ä½å’—æ¢é±·é­šå€‹é ­ã€‚

é±·é­šå¿ƒè«—ï¼š
ã€Œâ€¦â€¦ï¼Ÿã€
ä½†é˜¿å•¡å¤ª chillï¼Œè…³æ­¥ç©©å®šï¼Œæƒ…ç·’å¹³ç©©ï¼Œ
é±·é­šåè€Œå””æ•¢éƒã€‚

å†è¡Œå…©æ­¥ï¼Œ
é˜¿å•¡åˆè¸å’—å–ºä¸€éš»çœ¼é¡è›‡æ¢èƒŒè„Šä¸Šé¢ã€‚
çœ¼é¡è›‡æœ¬ä¾†æƒ³æŠ¬é ­ç¤ºå¨ï¼Œ
ä½†è¦‹åˆ°é˜¿å•¡å…¨ç¨‹ä½é ­æ»‘æ‰‹æ©Ÿï¼Œ
é€£çœ¼ç¥éƒ½å†‡ç•€éï¼Œ
æ¢è›‡çªç„¶è‡ªæˆ‘æ‡·ç–‘ï¼š
ã€Œæˆ‘ä¿‚å’ªå””å¤ å±éšªï¼Ÿã€

ä¹‹å¾Œä»²èª‡å¼µã€‚
ç…å­ã€è€è™ã€ç‹¼ã€ç”šè‡³ä¸€æ¢æš´èºå˜…èœœç¾ï¼Œ
å…¨éƒ¨è®Šæˆå’—ã€Œè¡Œäººè·¯ç£šã€ã€‚
è€Œé˜¿å•¡â€”â€”
åªä¿‚å–ºåº¦ç”¨ iPhone ç‡ç·Šä¸€æ¢å½±ç‰‡ï¼š
ã€Š10 å€‹æ–¹æ³•æ•™ä½ é»æ¨£æ”¾é¬†ã€‹ã€‚

åˆ°æœ€å¾Œï¼Œé˜¿å•¡åœä½ï¼ŒæŠ¬ä¸€æŠ¬é ­ï¼Œ
ç™¼ç¾è‡ªå·±ä¼å–ºä¸€åº§ã€Œç”±å±éšªå‹•ç‰©ç Œæˆå˜…å±±ã€ä¸Šé¢ã€‚
ä½¢çœ¨ä¸€çœ¨çœ¼ï¼Œ
å†ä½é ­ï¼Œç¹¼çºŒ tab tab tabã€‚

å› ç‚ºå°é˜¿å•¡åšŸè¬›â€”â€”
ä¸–ç•Œå†å±éšªï¼Œéƒ½æ•µå””éä¸€éš»å°ˆå¿ƒåˆ chill å˜… capybaraã€‚</textarea>

        <!-- ğŸ§  Speed & pitch sliders -->
        <div class="sliderRow">
          <div class="slider">
            <div class="sliderHead">
              <strong>Speed</strong>
              <span class="chip" id="rateLabel">1.00Ã—</span>
            </div>
            <input id="rate" type="range" min="0.5" max="1.5" step="0.05" value="1.0" />
            <div class="mini"><span>Slow</span><span>Fast</span></div>
          </div>

          <div class="slider">
            <div class="sliderHead">
              <strong>Pitch</strong>
              <span class="chip" id="pitchLabel">1.00</span>
            </div>
            <input id="pitch" type="range" min="0.0" max="2.0" step="0.05" value="1.0" />
            <div class="mini"><span>Low</span><span>High</span></div>
          </div>
        </div>

        <div class="controls">
          <button id="speak" class="btn primary" type="button">â–¶ Speak</button>
          <button id="pause" class="btn soft" type="button">â¸ Pause</button>
          <button id="resume" class="btn soft" type="button">âµ Resume</button>
          <button id="stop" class="btn warn" type="button">â–  Stop</button>
        </div>

        <div id="status"></div>

        <div class="hint">
          Tip: If no Cantonese voice appears, click â€œSpeakâ€ once, then Reload voices.<br />
          iOS note: Some voices only speak after a user gesture (button press). This page is built to behave nicely on iPhone/iPad.
        </div>
      </div>
    </div>

    <footer>
      <div style="max-width:680px;margin:0 auto;line-height:1.6;">
        Â© 2025 <strong>JoDFun Inc.</strong><br/>
        This web app is designed and implemented by JoDFun Inc.<br/>
        If youâ€™d like to collaborate, please email <a href="mailto:gideont@gmail.com">gideont@gmail.com</a>.
      </div>
    </footer>
  </div>

  <script>
    // -----------------------------
    // DOM
    // -----------------------------
    const voiceSel = document.getElementById('voice');
    const txt = document.getElementById('text');
    const statusEl = document.getElementById('status');

    const rateEl = document.getElementById('rate');
    const pitchEl = document.getElementById('pitch');
    const rateLabel = document.getElementById('rateLabel');
    const pitchLabel = document.getElementById('pitchLabel');

    const btnSpeak = document.getElementById('speak');
    const btnPause = document.getElementById('pause');
    const btnResume = document.getElementById('resume');
    const btnStop = document.getElementById('stop');
    const btnReload = document.getElementById('reload');

    const themeSwitch = document.getElementById('themeSwitch');

    // -----------------------------
    // Textarea auto-resize (mobile-friendly)
    // -----------------------------
    const MIN_TEXTAREA_HEIGHT = 190;
    function autoResize(el){
      el.style.height = 'auto';
      el.style.height = Math.max(el.scrollHeight, MIN_TEXTAREA_HEIGHT) + 'px';
    }
    txt.addEventListener('input', () => autoResize(txt));
    autoResize(txt);

    // -----------------------------
    // Status helpers
    // -----------------------------
    function setStatus(msg){
      statusEl.textContent = msg;
      console.log('[TTS]', msg);
    }

    // -----------------------------
    // Theme (ğŸŒˆ toggle + remembers preference)
    // -----------------------------
    function applyTheme(theme){
      document.documentElement.setAttribute('data-theme', theme);
      themeSwitch.setAttribute('aria-checked', theme === 'dark' ? 'true' : 'false');
      try { localStorage.setItem('jodfun_theme', theme); } catch {}
    }

    function initTheme(){
      const saved = (() => { try { return localStorage.getItem('jodfun_theme'); } catch { return null; } })();
      if (saved === 'dark' || saved === 'light') return applyTheme(saved);

      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      applyTheme(prefersDark ? 'dark' : 'light');
    }

    function toggleTheme(){
      const cur = document.documentElement.getAttribute('data-theme') || 'light';
      applyTheme(cur === 'dark' ? 'light' : 'dark');
    }

    themeSwitch.addEventListener('click', toggleTheme);
    themeSwitch.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleTheme(); }
    });
    initTheme();

    // -----------------------------
    // Web Speech API
    // -----------------------------
    const synth = window.speechSynthesis;
    let voiceMap = new Map();

    function loadVoices(){
      const voices = synth?.getVoices?.() || [];
      voiceSel.innerHTML = '';
      voiceMap.clear();
      voices.forEach(v => voiceMap.set(v.name, v));

      const preferred = voices
        .map(v => {
          const name = (v.name || '').toLowerCase();
          const lang = (v.lang || '').toLowerCase();
          let score = 0;
          if (lang === 'yue-hk') score += 100;
          if (lang === 'zh-hk') score += 60;
          if (name.includes('ç²µèª') || name.includes('cantonese') || name.includes('yue')) score += 50;
          if (name.includes('google')) score += 10;
          return { v, score };
        })
        .sort((a,b) => b.score - a.score)
        .map(x => x.v);

      preferred.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.name;
        opt.textContent = `${v.name} â€” ${v.lang}`;
        voiceSel.appendChild(opt);
      });

      // Select remembered voice if exists
      const savedVoice = (() => { try { return localStorage.getItem('jodfun_voice'); } catch { return null; } })();
      if (savedVoice && voiceMap.has(savedVoice)) {
        voiceSel.value = savedVoice;
      }

      if (voiceSel.options.length){
        setStatus(`Loaded ${voiceSel.options.length} voices.`);
      } else {
        setStatus('No voices detected yet.');
      }
    }

    voiceSel.addEventListener('change', () => {
      try { localStorage.setItem('jodfun_voice', voiceSel.value); } catch {}
      setStatus(`Selected: ${voiceSel.value}`);
    });

    // iOS / Chrome quirk: voices can appear later
    if (synth && 'onvoiceschanged' in synth) synth.onvoiceschanged = loadVoices;
    setTimeout(loadVoices, 200);

    // -----------------------------
    // Sliders (ğŸ§  speed & pitch) + remember
    // -----------------------------
    function setSliderLabels(){
      rateLabel.textContent = `${Number(rateEl.value).toFixed(2)}Ã—`;
      pitchLabel.textContent = `${Number(pitchEl.value).toFixed(2)}`;
    }

    function loadPrefs(){
      try {
        const r = localStorage.getItem('jodfun_rate');
        const p = localStorage.getItem('jodfun_pitch');
        if (r) rateEl.value = r;
        if (p) pitchEl.value = p;
      } catch {}
      setSliderLabels();
    }

    function savePrefs(){
      try {
        localStorage.setItem('jodfun_rate', rateEl.value);
        localStorage.setItem('jodfun_pitch', pitchEl.value);
      } catch {}
    }

    rateEl.addEventListener('input', () => { setSliderLabels(); savePrefs(); });
    pitchEl.addEventListener('input', () => { setSliderLabels(); savePrefs(); });
    loadPrefs();

    // -----------------------------
    // Speak controls
    // -----------------------------
    let lastUtterance = null;

    function buildUtterance(text){
      const u = new SpeechSynthesisUtterance(text);

      const v = voiceMap.get(voiceSel.value);
      if (v) u.voice = v;

      u.rate = Number(rateEl.value);
      u.pitch = Number(pitchEl.value);

      u.onstart = () => setStatus(
        `Speaking with ${u.voice?.name || 'default voice'} â€¢ speed ${u.rate.toFixed(2)}Ã— â€¢ pitch ${u.pitch.toFixed(2)}`
      );
      u.onend = () => setStatus('Done.');
      u.onerror = (e) => setStatus(`TTS error: ${e.error || 'unknown'}`);

      return u;
    }

    function speak(){
      const text = (txt.value || '').trim();
      if (!text) return setStatus('No text to speak.');

      // iOS safety: resume may be required
      try { synth.resume(); } catch {}

      // Cancel any previous speech
      try { synth.cancel(); } catch {}

      lastUtterance = buildUtterance(text);
      synth.speak(lastUtterance);

      // quick check (useful when audio output is blocked)
      setTimeout(() => {
        if (!synth.speaking) {
          setStatus('Not speaking. Check: sound output device / browser autoplay permissions / system volume.');
        }
      }, 600);
    }

    btnSpeak.onclick = speak;
    btnPause.onclick = () => { try { synth.pause(); } catch {} setStatus('Paused.'); };
    btnResume.onclick = () => { try { synth.resume(); } catch {} setStatus('Resumed.'); };
    btnStop.onclick = () => { try { synth.cancel(); } catch {} setStatus('Stopped.'); };
    btnReload.onclick = loadVoices;

    // iOS: keep audio alive after user gesture
    document.addEventListener('touchstart', () => { try { synth.resume(); } catch {} }, { passive: true });
  </script>
</body>
</html>
